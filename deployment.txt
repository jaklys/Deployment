import subprocess
from collections import defaultdict
import re

def test_dns_balancing(domains, num_requests=10):
    results = {}

    for domain in domains:
        ip_count = defaultdict(int)

        for _ in range(num_requests):
            try:
                # Execute nslookup for the given domain
                result = subprocess.run(['nslookup', domain], capture_output=True, text=True)
                output = result.stdout

                # Extract the IP addresses from the "Non-authoritative answer" section
                matches = re.findall(r'Address:\s+(\S+)', output)
                if matches:
                    # The first address is typically the DNS server's, subsequent ones are the queried domain's
                    if len(matches) > 1:
                        ip = matches[1]  # Get the second IP address, which should be the target domain's IP
                        ip_count[ip] += 1
                    else:
                        print("No additional IP address found")
                else:
                    print("No IP address found in 'Non-authoritative answer'")
                    
            except subprocess.SubprocessError as e:
                print(f'An error occurred while executing nslookup: {e}')
        
        # Store results for the given domain
        results[domain] = ip_count

    # Print the results for all tested domains
    for domain, counts in results.items():
        print(f'Results for domain {domain}:')
        for ip, count in counts.items():
            print(f'  IP address {ip} was returned {count} times out of {num_requests} requests.')
        print()  # New line for better readability

# Use the function
test_dns_balancing(['fiat-emeaprod-1b-halo'], num_requests=20)