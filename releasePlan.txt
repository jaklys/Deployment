# Implementation Plan: GitLab CI/CD Pipeline – Nolio Replacement

## 1. Overview

### Goal
Replace Nolio as the deployment orchestrator with a GitLab CI/CD pipeline. Extend Chuck with a new `release` action and a built-in Agent (REST API) to eliminate dependency on the Nolio Agent.

### Current Flow
```
WatchTower (super_recipe)
  ├── Generates .config file (hostnames, applications, versions)
  ├── Generates recipe_main_CHxxxxxxx.json (services, ports, healthchecks)
  ├── Generates nolio_links.json (pre-built Nolio deployment links)
  └── Calls Nolio API → creates deployment plans & links
          │
          ▼
      Nolio (orchestrator)
          │ Maps ENV ↔ Hostnames, holds deployment links
          │ On "Run" click, triggers via Nolio Agent:
          ▼
      Chuck Nolio Agent (on target server)
          │ Receives command from Nolio Agent
          │ Calls Chuck.exe --action install
          ▼
      Chuck.exe (on target server)
          │ Copies artifacts from NAS
          │ Configures NodeRunner
          │ Restarts services
          ▼
      Deployment complete
```

### New Flow (after implementation)
```
WatchTower (super_recipe)
  ├── Generates .config file (hostnames, applications, versions)
  ├── Generates recipe_main_CHxxxxxxx.json (services, ports, healthchecks)
  └── Saves to NAS (shared disk)
          │
          ▼
      GitLab CI/CD Pipeline (manual trigger)
          │ Parameters: CR number + system credentials (from Vault)
          │ Reads configuration from NAS by CR number
          │ Parses .config → list of hostnames
          │ Calls Chuck Agent REST API on each target server (parallel)
          ▼
      Chuck Agent (built-in REST API on target server)
          │ Receives request → runs Chuck locally
          │ Chuck --action release
          │ Copies artifacts from NAS, configures, restarts
          ▼
      Deployment complete
```

### What Changes

| Component | Before | After |
|---|---|---|
| WatchTower (super_recipe) | Generates config + calls Nolio API + generates nolio_links.json | Generates config on NAS only (no Nolio calls, no nolio_links.json) |
| Nolio | Orchestrates deployments, holds links | **Decommissioned** |
| nolio_links.json | Generated by WatchTower | **No longer generated** |
| Chuck Nolio Agent | Receives commands from Nolio Agent | **Removed** – replaced by built-in Chuck Agent |
| Chuck.exe | `--action install` called via Nolio Agent | Extended with `--action release` + built-in REST API (Chuck Agent) |
| GitLab CI/CD | Does not exist | **New orchestrator** (replaces Nolio) |
| NAS (shared disk) | Artifacts + config files | No change |

---

## 2. Prerequisites

### Infrastructure
- [ ] GitLab instance available and configured
- [ ] GitLab Runner installed (runs separately from target servers)
- [ ] GitLab Runner has network access to NAS (shared disk) for reading configuration
- [ ] GitLab Runner has network access to Chuck Agent REST API on all target servers
- [ ] Firewall rules permit GitLab Runner → target server communication on Chuck Agent port

### Verification Before Start
- [ ] Test NAS access from GitLab Runner – read files from recipe folder
- [ ] Test network connectivity from GitLab Runner to each target server on Chuck Agent port
- [ ] Confirm .config file format and parsing rules
- [ ] Confirm recipe_main_CHxxxxxxx.json format and structure

---

## 3. Implementation Phases

### Phase 1: Chuck Extension – New Action and Built-in Agent

#### 1.1 New Chuck Action: `release`
- Add new action `release` to Chuck
- The action encapsulates the full deployment workflow previously triggered via `--action install` through Nolio
- Must be callable both locally (CLI) and remotely (via Chuck Agent API)
- Must return structured result (success/failure, details, deployed services, errors)

#### 1.2 Chuck Agent – Built-in REST API Server
- Build a lightweight REST API server into Chuck that replaces the Nolio Agent
- Runs as a Windows service on each target server
- Endpoints needed:
  - Trigger a release action (accepts CR number and credentials)
  - Check status of a running deployment (by job ID)
  - Agent healthcheck
- The agent runs `chuck --action release` as a subprocess and tracks job status
- GitLab pipeline polls for completion

#### 1.3 Remove Chuck Nolio Agent
- [ ] Identify and remove all Nolio Agent integration code from Chuck codebase
- [ ] Remove Nolio Agent from target servers (uninstall service)
- [ ] Update Chuck documentation

---

### Phase 2: WatchTower (super_recipe) Modifications

#### 2.1 Remove Nolio Integration
- [ ] Remove code that generates `nolio_links.json`
- [ ] Remove code that calls Nolio API for creating deployment plans
- [ ] Remove code that retrieves Nolio deployment links
- [ ] Remove any Nolio-related configuration, environment variables, and dependencies

#### 2.2 Keep Unchanged
- `.config` file generation (hostnames, applications, versions)
- `recipe_main_CHxxxxxxx.json` generation (services, ports, healthchecks)
- NAS output path and folder structure
- super_recipe UI (except Nolio links section removed)

---

### Phase 3: GitLab CI/CD Pipeline Implementation

#### 3.1 Rough Pipeline Structure

```yaml
stages:
  - validate
  - prepare
  - deploy
  - verify

# Manual trigger with parameters:
#   - CR_NUMBER (e.g. CH1021983707)
#   - SYS_USERNAME (from Vault)
#   - SYS_PASSWORD (from Vault)

validate-inputs:
  stage: validate
  # Validate CR number format
  # Validate credentials are provided
  # Validate config files exist on NAS for given CR number

read-config:
  stage: prepare
  # Read config files from NAS by CR number
  # Parse .config → hostnames, applications, versions
  # Parse recipe_main .json → services, ports, healthchecks
  # Output deployment manifest as artifact

deploy:
  stage: deploy
  # Read deployment manifest
  # For each hostname: spawn parallel subprocess
  # Each subprocess calls Chuck Agent REST API on target server
  # Poll for completion, collect results
  # Fail pipeline if any host fails

verify-deployment:
  stage: verify
  # For each hostname and service: call healthcheck endpoints
  # Report pass/fail summary
  allow_failure: true
```

#### 3.2 Deploy Stage – Parallel Execution
- One subprocess per target hostname, all running concurrently
- Each subprocess: triggers release via Chuck Agent API, polls for completion
- Parent process collects all results independently
- Failure on one host does not stop others
- Pipeline exits with non-zero if any host failed

---

### Phase 4: Testing

#### 4.1 Unit Tests
- [ ] Config file parsing (`.config` and `recipe_main_*.json`)
- [ ] Chuck `release` action logic
- [ ] Chuck Agent API endpoints
- [ ] Deployment manifest generation

#### 4.2 Integration Tests
- [ ] End-to-end test on DEV/TEST environment (full flow: WatchTower → GitLab → Chuck Agent → Chuck release)
- [ ] Multi-server parallel deployment
- [ ] Error scenarios: non-existent CR, unreachable Chuck Agent, timeout, invalid credentials, partial failure

#### 4.3 Parallel Run
- [ ] Run deployments through both Nolio and GitLab simultaneously for 1–2 weeks
- [ ] Compare results and deployment duration
- [ ] Confirm GitLab pipeline achieves identical outcomes

---

### Phase 5: Migration and Rollout

#### 5.1 Staged Rollout
1. **Pilot:** 1 non-critical application / environment via GitLab
2. **Expand:** Additional applications and environments
3. **Full rollout:** All applications and environments through GitLab

#### 5.2 Nolio Decommission
- [ ] After successful full rollout and stabilization period (min. 2 weeks):
  - Disable Nolio deployment plans
  - Remove Nolio Agent from target servers
  - Archive historical Nolio deployment records

#### 5.3 Chuck Nolio Agent Removal
- [ ] Uninstall Chuck Nolio Agent service from all target servers
- [ ] Remove Chuck Nolio Agent code from Chuck repository
- [ ] Verify Chuck Agent (new built-in) is running on all servers

---

## 4. Definition of Done

- [ ] Chuck extended with `--action release` and built-in Agent REST API
- [ ] Chuck Nolio Agent removed from all target servers and codebase
- [ ] WatchTower no longer generates `nolio_links.json` or calls Nolio API
- [ ] GitLab pipeline successfully deploys applications to all target servers in parallel
- [ ] All healthchecks pass after deployment
- [ ] Pipeline has retry logic and error handling for each host independently
- [ ] Operator documentation exists (how to trigger pipeline, how to troubleshoot failures)
- [ ] Nolio is decommissioned
- [ ] Parallel run confirmed consistent results between old and new flow
